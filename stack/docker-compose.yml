version: '3.8'

services:

    elasticsearch:
        build:
            context: custom/elasticsearch
            network: host
            args:
                - ELASTICSEARCH_VERSION=${ELASTICSEARCH_VERSION:-7.3.2}
        env_file: 
            - .env_elasticsearch_${ENV_FILE_VERSION:-7}
        environment:
            - node.name="es-stack-1"
        ports:
            - "${ELASTICSEARCH_PORT:-9200}:9200"
        networks:
            - stack
        volumes:
            - type: bind
              source: ../snapshots
              target: /snapshots
        user: ${CURRENT_UID}

    kibana:
        build:
            context: custom/kibana
            network: host
            args:
                - KIBANA_VERSION=${KIBANA_VERSION:-7.3.2}
                - KIBANA_PASS=${kibana}
                - KIBANA_USER=kibana
                - KIBANA_KEY=381d84e2ad314abf0f22e612a2cfa28e7062c8335848b7777c0c4bb1de81e15f
        env_file: 
            - .env_kibana_${ENV_FILE_VERSION:-7}
        environment:
            - ELASTICSEARCH_HOSTS="http://elasticsearch:9200"
        ports:
            - "${KIBANA_PORT:-5601}:5601"
        depends_on:
            - elasticsearch
        networks:
            - stack
        user: ${CURRENT_UID}

    logstash-data-loader:
        build:
            context: custom/logstash-data-loader
            network: host
            args:
                - LOGSTASH_VERSION=${LOGSTASH_VERSION:-7.3.2}
        env_file:
            - .env_logstash-data-loader_${ENV_FILE_VERSION:-7}
        ports:
            - "${LOGSTASH_PORT:-9600}:9600"
        depends_on:
            - elasticsearch
        networks:
            - stack
        volumes:
            - ../data:/data
        user: ${CURRENT_UID}

    enterprise-search:
        image: docker.elastic.co/enterprise-search/enterprise-search:7.7.0
        depends_on:
            - elasticsearch
        environment:
            - elasticsearch.host=http://elasticsearch:9200
            - allow_es_settings_modification=true
            - secret_management.encryption_keys=["381d84e2ad314abf0f22e612a2cfa28e7062c8335848b7777c0c4bb1de81e15f"]
            - elasticsearch.username=elastic
            - elasticsearch.password=${elastic}
            - ent_search.auth.source=elasticsearch-native
        ports:
            - "${ENTERPRISE_SEARCH_PORT:-3002}:3002"
        networks:
            - stack

    es-loader:
        build:
            context: custom/es-loader
            network: host
        depends_on:
            - elasticsearch
        networks:
            - stack
        volumes:
            - ../index-templates:/index-templates
            - ../bin:/stack-bin
        command: bash /stack-bin/init.sh /index-templates elasticsearch
        environment:
            - ES_USER=elastic
            - ES_PASS=${elastic}
        user: ${CURRENT_UID}

networks:
    stack:
